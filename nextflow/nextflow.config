// Nextflow configuration for SynthDNM pipeline
// Per-chromosome processing (no region chunking)

// ============================================================================
// Default parameters
// ============================================================================

params {
    outdir = "output"
    trace_prefix = ""
    chroms = "chr22"

    // Container
    bcftools_container = "/expanse/projects/sebat1/s3/data/sebat/g2mh/scripts/scripts_for_rare_pipeline/bcftools:1.22--h3a4d415_1"
}

// ============================================================================
// Singularity settings
// ============================================================================

singularity {
    enabled = true
    autoMounts = true
    runOptions = '-B /expanse/projects/sebat1'
}

// ============================================================================
// Process defaults
// ============================================================================

process {
    executor = "slurm"
    queue = "ind-shared"
    clusterOptions = "--account=ddp195 --ntasks=1 --nodes=1"
    beforeScript = "module load cpu/0.17.3b singularitypro"

    // Default resources (overridden per-process below)
    cpus = 8
    memory = '32 GB'
    time = '8h'

    // GET_PRIVATE_VARIANTS - filtering is fast
    withName: 'GET_PRIVATE_VARIANTS' {
        memory = { chrom in ['chr1', 'chr2', 'chr3'] ? '48 GB' : '32 GB' }
        time = { chrom in ['chr1', 'chr2'] ? '6h' : '4h' }
        publishDir = [path: "${params.outdir}/private_variants", mode: "link"]
    }

    // TRIO_DNM2 - main compute step
    withName: 'TRIO_DNM2_SWAPPED' {
        memory = { chrom in ['chr1', 'chr2', 'chr3'] ? '64 GB' : '48 GB' }
        time = { chrom in ['chr1', 'chr2'] ? '8h' : chrom in ['chr3', 'chr4', 'chr5', 'chr6'] ? '6h' : '4h' }
        publishDir = [path: "${params.outdir}/synthetic_dnms", mode: "link"]
    }

    withName: 'TRIO_DNM2_REAL' {
        memory = { chrom in ['chr1', 'chr2', 'chr3'] ? '64 GB' : '48 GB' }
        time = { chrom in ['chr1', 'chr2'] ? '8h' : chrom in ['chr3', 'chr4', 'chr5', 'chr6'] ? '6h' : '4h' }
        publishDir = [path: "${params.outdir}/putative_dnms", mode: "link"]
    }
}

// ============================================================================
// Executor settings
// ============================================================================

executor {
    queueSize = 100
    submitRateLimit = "20/1min"
}

// ============================================================================
// Reports and tracing
// ============================================================================

trace {
    enabled = true
    file = "reports/${params.trace_prefix}trace.txt"
    overwrite = true
    fields = 'task_id,hash,native_id,process,tag,status,exit,submit,start,complete,duration,realtime,cpus,memory,rss,vmem,%cpu,%mem,queue,container'
}

report {
    enabled = true
    file = "reports/${params.trace_prefix}report.html"
    overwrite = true
}

timeline {
    enabled = true
    file = "reports/${params.trace_prefix}timeline.html"
    overwrite = true
}

dag {
    enabled = true
    file = "reports/${params.trace_prefix}dag.html"
    overwrite = true
}

// ============================================================================
// Profiles for different cohorts
// ============================================================================

profiles {
    // SSC WGS - original synthdnm cohort
    ssc_wgs {
        params.vcf_dir = "/expanse/projects/sebat1/j3guevar/SFARI/SSC/JG"
        params.vcf_pattern = "*_{chrom}.*.vcf.gz"
        params.ped_file = "${projectDir}/resources/SSC.psam"
        params.swapped_ped_file = "${projectDir}/resources/SSC.swapped.psam"
    }

    // SPARK iWES v3
    spark_iwes {
        params.vcf_dir = "/expanse/projects/sebat1/s3/data/sebat/SPARK_iWES_v3/variants/snv/deepvariant/pvcf"
        params.vcf_pattern = "SPARK.iWES_v3.2024_08.deepvariant.{chrom}.vcf.gz"
        params.ped_file = "${projectDir}/resources/SPARK_iWES_v3.psam"
        params.swapped_ped_file = "${projectDir}/resources/SPARK_iWES_v3.swapped.psam"
    }

    // SPARK iWGS v1.1
    spark_iwgs {
        params.vcf_dir = "/expanse/projects/sebat1/s3/data/sebat/SSC_JG/gatk"
        params.vcf_pattern = "wgs_12519_genome.deepvariant.{chrom}.vcf.gz"
        params.ped_file = "${projectDir}/resources/SPARK_iWGS_v1.1.psam"
        params.swapped_ped_file = "${projectDir}/resources/SPARK_iWGS_v1.1.swapped.psam"
    }
}

// ============================================================================
// Workflow completion summary
// ============================================================================

workflow.onComplete = {
    println """
    ===========================================
    SynthDNM Pipeline Complete
    Status: ${workflow.success ? 'SUCCESS' : 'FAILED'}
    Duration: ${workflow.duration}
    ===========================================
    """.stripIndent()
}

manifest {
    name = 'synthdnm-pipeline'
    author = 'James Guevara'
    description = 'Generate synthetic de novo mutations for DNM classifier training'
    version = '1.0.0'
    mainScript = 'main.nf'
    nextflowVersion = '>=24.0.0'
}
